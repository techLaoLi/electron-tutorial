## 02 主进程与渲染进程

- 目标：理解 Electron 的双进程架构与职责划分。

### 概念

- 主进程（Main）：控制应用生命周期，创建原生窗口，访问 Node 能力
- 渲染进程（Renderer）：负责页面 UI（HTML/CSS/JS），运行在类似浏览器环境
- 进程间关系

### 启动流程

1. 主进程启动应用与窗口
2. 窗口载入渲染进程页面
3. 通过预加载脚本与 IPC 进行沟通（第 03、05 章）

### 最小主进程示例（TypeScript）

```ts
import { app, BrowserWindow } from "electron";

let mainWindow: BrowserWindow | null = null;

function createWindow() {
  mainWindow = new BrowserWindow({
    width: 1000,
    height: 700,
    webPreferences: {
      preload: __dirname + "/preload.js",
      contextIsolation: true,
      nodeIntegration: false,
    },
  });
  mainWindow.loadFile("index.html");
  mainWindow.on("closed", () => (mainWindow = null));
}

app.whenReady().then(createWindow);
app.on("window-all-closed", () => process.platform !== "darwin" && app.quit());
app.on(
  "activate",
  () => BrowserWindow.getAllWindows().length === 0 && createWindow()
);
```

### 多窗口管理

```typescript
// 补充：多窗口场景
let windows: BrowserWindow[] = [];

function createChildWindow(parent: BrowserWindow) {
  const child = new BrowserWindow({
    parent,
    modal: true,
    width: 400,
    height: 300,
  });
  windows.push(child);
  child.on("closed", () => {
    windows = windows.filter((w) => w !== child);
  });
}
```

### 进程崩溃处理

```typescript
// 补充：渲染进程崩溃恢复
mainWindow.webContents.on("crashed", () => {
  console.log("渲染进程崩溃，正在恢复...");
  mainWindow.reload();
});

// 主进程异常处理
process.on("uncaughtException", (error) => {
  console.error("未捕获的异常:", error);
  // 记录日志或重启应用
});
```

### 性能优化要点

```typescript
// 补充：性能相关配置
const win = new BrowserWindow({
  webPreferences: {
    // 启用硬件加速
    hardwareAcceleration: true,
    // 禁用不必要的功能
    experimentalFeatures: false,
    // 内存管理
    backgroundThrottling: false,
  },
});
```

### 安全最佳实践

```typescript
// 补充：安全配置
const win = new BrowserWindow({
  webPreferences: {
    // 安全配置
    contextIsolation: true,
    nodeIntegration: false,
    enableRemoteModule: false,
    // CSP 内容安全策略
    webSecurity: true,
    allowRunningInsecureContent: false,
  },
});
```

### 调试和开发工具

```typescript
// 补充：开发环境配置
if (process.env.NODE_ENV === "development") {
  win.webContents.openDevTools();
  win.loadURL("http://localhost:3000");
} else {
  win.loadFile("dist/index.html");
}
```

### 进程间数据共享

```typescript
// 补充：进程间状态管理
// 主进程维护全局状态
let appState = {
  user: null,
  settings: {},
  windows: [],
};

// 通过 IPC 同步状态
ipcMain.handle("get-app-state", () => appState);
ipcMain.handle("update-app-state", (event, newState) => {
  appState = { ...appState, ...newState };
  // 通知所有渲染进程状态变化
  BrowserWindow.getAllWindows().forEach((win) => {
    win.webContents.send("state-changed", appState);
  });
});
```

### 本章要点

- 主进程 ≈ 后台控制中心；渲染进程 ≈ 前端页面
- 所有原生能力应由主进程授权并通过安全通道暴露
