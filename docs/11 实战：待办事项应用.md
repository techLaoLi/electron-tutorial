## 10 实战：待办事项应用

- 目标：综合前九章，完成一个可打包的 Todo 桌面应用。

### 关键功能
- 添加/勾选/删除待办
- 本地持久化（JSON 文件）
- 菜单与快捷键：新建、导出、开发者工具

### 目录结构建议
```
src/
  main/
    index.ts
    ipc.ts
    store.ts           # 简单 JSON 存储
    menu.ts
    tray.ts
  preload.ts
  renderer/
    index.html
    main.ts
```

### 存储（主进程）
```ts
import { promises as fs } from 'node:fs'
import path from 'node:path'

const dataDir = path.join(app.getPath('userData'), 'data')
const dataFile = path.join(dataDir, 'todos.json')

export async function loadTodos() {
  try { await fs.mkdir(dataDir, { recursive: true }) } catch {}
  try { return JSON.parse(await fs.readFile(dataFile, 'utf8')) } catch { return [] }
}

export async function saveTodos(todos: any[]) {
  await fs.writeFile(dataFile, JSON.stringify(todos, null, 2), 'utf8')
}
```

### IPC（主进程）
```ts
ipcMain.handle('todo:list', async () => loadTodos())
ipcMain.handle('todo:add', async (_e, text: string) => {
  const todos = await loadTodos()
  const next = [...todos, { id: Date.now(), text, done: false }]
  await saveTodos(next)
  return next
})
ipcMain.handle('todo:toggle', async (_e, id: number) => {
  const todos = await loadTodos()
  const next = todos.map((t: any) => t.id === id ? { ...t, done: !t.done } : t)
  await saveTodos(next); return next
})
ipcMain.handle('todo:remove', async (_e, id: number) => {
  const todos = await loadTodos()
  const next = todos.filter((t: any) => t.id !== id)
  await saveTodos(next); return next
})
```

### 预加载
```ts
contextBridge.exposeInMainWorld('todo', {
  list: () => ipcRenderer.invoke('todo:list'),
  add: (text: string) => ipcRenderer.invoke('todo:add', text),
  toggle: (id: number) => ipcRenderer.invoke('todo:toggle', id),
  remove: (id: number) => ipcRenderer.invoke('todo:remove', id)
})
```

### 渲染端 UI（最小实现）
```html
<div id="app">
  <form id="f"><input id="i" placeholder="添加待办"/></form>
  <ul id="list"></ul>
</div>
<script type="module">
const listEl = document.getElementById('list')
const input = document.getElementById('i')
const form = document.getElementById('f')

async function render() {
  const todos = await window.todo.list()
  listEl.innerHTML = ''
  for (const t of todos) {
    const li = document.createElement('li')
    li.textContent = (t.done ? '✅ ' : '⬜ ') + t.text
    li.onclick = async () => { await window.todo.toggle(t.id); render() }
    li.oncontextmenu = async (e) => { e.preventDefault(); await window.todo.remove(t.id); render() }
    listEl.appendChild(li)
  }
}

form.onsubmit = async (e) => {
  e.preventDefault(); const v = input.value.trim(); if (!v) return
  await window.todo.add(v); input.value = ''; render()
}

render()
</script>
```

### 打包与验证
- 按第 08 章配置 `electron-builder`，运行 `npm run dist`
- 安装后验证数据持久化、菜单与快捷键

### 本章要点
- 严格通过预加载暴露 API
- 所有数据读写在主进程完成并做校验
